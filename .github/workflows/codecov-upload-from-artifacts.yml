name: 'Codecov upload'
on:
  workflow_call:
    inputs:
      artifacts-pattern:
        required: true
        type: string
    secrets:
      TOKEN:
        required: true
    outputs:
      uploads:
        description: TODO
        value: ${{ jobs.upload.outputs.uploads }}

jobs:
  prepare:
    name: Prepare
    runs-on: ubuntu-latest
    outputs:
      map: ${{ steps.load-groups-metadata.outputs.map }}
      matrix: ${{ steps.load-groups-metadata.outputs.matrix }}
      reports: ${{ steps.load-groups-metadata.outputs.reports }}
    steps:
      # @TODO move load-groups-metadata action to a dedicated repo and remove the checkout
      - uses: actions/checkout@v3
        with:
          path: custom-action-repo

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: ${{ inputs.artifacts-pattern }}
          path: job-artifacts

      - name: DEBUG artifacts
        run: |
          ls -ail job-artifacts/*
          ls -ail job-artifacts/*/*

      - name: Load groups metadata
        id: load-groups-metadata
        uses: ./custom-action-repo/.github/actions/load-groups-metadata
        with:
          root: job-artifacts

      - name: DEBUG Load groups metadata
        run: |
          echo 'map='"'"'${{ steps.find-groups-metadata.outputs.map }}'"'"
          echo 'matrix='"'"'${{ steps.find-groups-metadata.outputs.matrix }}'"'"
          echo 'reports='"'"'${{ steps.find-groups-metadata.outputs.reports }}'"'"

  upload:
    name: "Upload '${{ matrix.name }}' reports group"
    runs-on: ubuntu-latest
    needs: [ prepare ]
    strategy:
      fail-fast: true
      max-parallel: 4
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}
    outputs: # /!\ Doesn't work properly due to matrix usage (last job override everything :/)
      name: ${{ steps.upload.outputs.name }}
      files: ${{ steps.upload.outputs.files }}
      flags: ${{ steps.upload.outputs.flags }}
      result: ${{ steps.upload.outputs.result }}
    steps:
      - name: DEBUG matrix
        run: echo 'matrix='"'"'${{ toJson(matrix) }}'"'"

      # Codecov uploader requires the repository to be there !
      # @TODO see if by manually filling sha/branch/pr etc, it's still required !
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Guess artifact name
        id: guess-artifact
        uses: actions/github-script@v7
        env:
          PATH: ${{ matrix.path }}
        with:
          script: |
            const { PATH } = process.env;
            const pathComponents = PATH.split('/');
            const artifactName = '/' === PATH[0] ? pathComponents[1] : pathComponents[0];
            // Remove: leading slash (if it exists) + the artifact name (=directory name) + trealing slash
            const groupPathFromArtifact = PATH.substr(('/' === PATH[0] ? 1 : 0) + artifactName.length + 1);

            core.setOutput("name", artifactName);
            core.setOutput("group-path-from-artifact", groupPathFromArtifact);

      - name: Download '${{ steps.guess-artifact.outputs.name }}' artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ steps.guess-artifact.outputs.name }}
          path: job-artifacts

      - name: DEBUG artifacts
        run: |
          ls -ail job-artifacts/*
          ls -ail job-artifacts/*/*

      # @TODO move codecov-group-upload action to a dedicated repo and remove the checkout
      - name: Upload group reports
        id: upload
        uses: ./.github/actions/codecov-group-upload
        with:
          token: ${{ secrets.TOKEN }}
          path: job-artifacts/${{ steps.guess-artifact.outputs.group-path-from-artifact }}

      - name: DEBUG Upload group reports
        run: |
          echo 'name='"'"'${{ steps.upload.outputs.name }}'"'"
          echo 'files='"'"'${{ steps.upload.outputs.files }}'"'"
          echo 'flags='"'"'${{ steps.upload.outputs.flags }}'"'"
          echo 'result='"'"'${{ steps.upload.outputs.result }}'"'"
