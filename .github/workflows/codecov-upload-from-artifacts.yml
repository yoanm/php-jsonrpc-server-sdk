# To store on same repo as reports-group/codecov-uploader-action action if doable
name: 'Codecov report groups upload'
on:
  workflow_call:
    inputs:
      artifacts-pattern:
        description: TODO
        required: true
        type: string
      run-id:
        description: |
          The id of the workflow run where the artifacts were uploaded from (default to current run).
          In case artifacts have been uploadded from another run, this input must be filled with original workflow run id !
        required: false
        type: string
        default: "${{ github.run_id }}"
      override-commit:
        description: |
          Force the commit SHA linked to the uploaded reports.
          Mostly useful for specific cases (e.g. `workflow_run` workflow).
          
          In case input is filled, `override-branch` input (as well as `override-pr` in case of `pull_request` event)
          should be filled too in order to keep consitency between values !
        required: false
        type: string
      override-branch:
        description: |
          Force the branch linked to the uploaded reports.
          Mostly useful for specific cases (e.g. `workflow_run` workflow).
          
          In case input is filled, `override-commit` input (as well as `override-pr` in case of `pull_request` event)
          should be filled too in order to keep consitency between values !
        required: false
        type: string
      override-pr:
        description: |
          Force the PR linked to the uploaded reports.
          Mostly useful for specific cases (e.g. `workflow_run` workflow triggered by a `pull_request` workflow).
          
          In case input is filled, `override-commit` and `override-branch` inputs should be filled too in order
          to keep consitency between values !
        required: false
        type: string
      override-build:
        description: |
          Workflow run ID to link to the uploaded reports.
          Mostly useful for specific cases (e.g. `workflow_run` workflow).
          
          When `run-id` input is provided, this input should most likely have the same value.
        required: false
        type: string
      override-build-url:
        description: |
          Workflow run url to link to the uploaded reports.
          Usually something like `${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}` (based on GHA environment variables).
          Mostly useful for specific cases (e.g. `workflow_run` workflow).
          
          In case input is filled, `override-build` input most likely need to be filled too in order to keep consitency between values !
        required: false
        type: string
      follow-symbolic-links:
        description: |
          Indicates whether to follow symbolic links when resolving glob path.
          When looking for group directory for instance.
        required: false
        type: boolean
        default: false
    secrets:
      TOKEN:
        required: true
    outputs:
      groups-count:
        description: TODO
        value: ${{ jobs.prepare.outputs.groups-count }}
      group-paths:
        description: TODO
        value: ${{ jobs.prepare.outputs.group-paths }}

jobs:
  prepare:
    name: 📮 🗃️ Prepare uploads
    runs-on: ubuntu-latest
    outputs:
      groups-count: ${{ steps.find-groups.outputs.count }}
      matrix: ${{ steps.find-groups.outputs.matrix }}
      group-paths: ${{ steps.find-groups.outputs.paths }}
    permissions:
      contents: read
      checks: write # For the check run creation ! @TODO check if doable to use inputs there and set read rather than write if ${{ !inputs.with-check-run }}
    steps:
      # @TODO move actions to a dedicated repo and remove the checkout
      - uses: actions/checkout@v4
        with:
          path: custom-action-repo

      - uses: ./custom-action-repo/.github/actions/reports-group/attach-check-run-to-triggering-workflow-action
        if: ${{ 'workflow_run' == github.event_name }}
        with:
          name: "My custom check"
          github-token: ${{ github.token }}
          job-status: ${{ job.status }}

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: ${{ inputs.artifacts-pattern }}
          path: job-artifacts
          github-token: ${{ github.token }} # Required in order to use `run-id` parameter !
          run-id: ${{ inputs.run-id }} # Required in case workflow is executed from another run (e.g. `workflow_run`)

      - name: DEBUG artifacts
        run: |
          ls -ail job-artifacts/*
          ls -ail job-artifacts/*/*

      - name: Find groups
        id: find-groups
        uses: ./custom-action-repo/.github/actions/reports-group/find-action
        with:
          path: job-artifacts
          format: glob-string
          glue-string: ','
          artifacts-mode: true
          group-by: format,flags
          matrix-mode: true
          follow-symbolic-links: ${{ inputs.follow-symbolic-links }}

      - name: DEBUG
        run: echo '${{ toJson(steps.find-groups.outputs) }}'

      # Codecov uploader requires the repository to be there !
      # @TODO see if by manually filling sha/branch/pr etc, it's still required !
      - name: Checkout Repository
        if: ${{ steps.find-groups.outputs.count == 1 }}
        uses: actions/checkout@v4

      - name: Fast-lane single group upload
        if: ${{ steps.find-groups.outputs.count == 1 }}
        uses: ./custom-action-repo/.github/actions/reports-group/codecov-uploader-action
        with:
          path: ${{ steps.find-groups.outputs.paths }}
          token: ${{ secrets.TOKEN }}
          override-commit: ${{ inputs.override-commit }}
          override-branch: ${{ inputs.override-branch }}
          override-pr: ${{ inputs.override-pr }}
          override-build: ${{ inputs.override-build }}
          override-build-url: ${{ inputs.override-build-url }}
          follow-symbolic-links: ${{ inputs.follow-symbolic-links }}

  uploads:
    name: "${{ matrix.artifact }} - ${{ matrix.path }}"
    runs-on: ubuntu-latest
    # If only one job exists, it should have been already executed on previous job (to avoid popping a runner just for one job)
    if: ${{ needs.prepare.outputs.groups-count > 1 }}
    needs: [ prepare ]
    strategy:
      fail-fast: true
      max-parallel: 4
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}
    permissions:
      contents: read
      checks: write # For the check run creation ! @TODO check if doable to use inputs there and set read rather than write if ${{ !inputs.with-check-run }}
    steps:
      - name: DEBUG matrix
        run: echo 'matrix='"'"'${{ toJson(matrix) }}'"'"

      # Codecov uploader requires the repository to be there !
      # @TODO see if by manually filling sha/branch/pr etc, it's still required !
      - name: Checkout Repository
        uses: actions/checkout@v4

      # @TODO move actions to a dedicated repo and remove the checkout
      - uses: actions/checkout@v4
        with:
          path: build/custom-action-repo

      - uses: ./build/custom-action-repo/.github/actions/reports-group/attach-check-run-to-triggering-workflow-action
        if: ${{ 'workflow_run' == github.event_name }}
        with:
          github-token: ${{ github.token }}
          job-status: ${{ job.status }}

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: ${{ matrix.artifact }}
          path: job-artifact
          github-token: ${{ github.token }} # Required in order to use `run-id` parameter !
          run-id: ${{ inputs.run-id }} # Required in case workflow is executed from another run (e.g. `workflow_run`)

      - name: DEBUG artifacts
        run: |
          ls -ail job-artifact/*
          ls -ail job-artifact/*/*

      - name: Upload reports
        id: upload
        uses: ./build/custom-action-repo/.github/actions/reports-group/codecov-uploader-action
        with:
          path: job-artifact/${{ matrix.path }}
          token: ${{ secrets.TOKEN }}
          override-commit: ${{ inputs.override-commit }}
          override-branch: ${{ inputs.override-branch }}
          override-pr: ${{ inputs.override-pr }}
          override-build: ${{ inputs.override-build }}
          override-build-url: ${{ inputs.override-build-url }}
          follow-symbolic-links: ${{ inputs.follow-symbolic-links }}
