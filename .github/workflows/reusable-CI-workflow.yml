name: 'CI reusable workflow'

on:
  workflow_call:

env:
  COMPOSER_PREFER_STABLE: '1'
  TEST_OUTPUT_STYLE: pretty

jobs:
  fetch-supported-versions:
    name: Fetch supported versions
    env:
      VERSIONS_FILEPATH: .github/workflows/supported-versions.json
    outputs:
      php-min: ${{ steps.parse-versions.outputs.php-min-version }}
      php-max: ${{ steps.parse-versions.outputs.php-max-version }}
      php-next: ${{ steps.parse-versions.outputs.php-next-version }}
    runs-on: ubuntu-latest
    steps:
      - name: Check out supported version file
        uses: actions/checkout@v5
        with:
          sparse-checkout: ${{ env.VERSIONS_FILEPATH }}
          sparse-checkout-cone-mode: false
      - name: Parse versions
        id: parse-versions
        run: |
          # Lowest PHP version to assess (e.g Lowest supported version including security support)
          echo "php-min-version=$( jq -r '.php.min' ${{ env.VERSIONS_FILEPATH }} )" >> $GITHUB_OUTPUT
          # Highest PHP version to assess (e.g Highest supported version)
          echo "php-max-version=$( jq -r '.php.max' ${{ env.VERSIONS_FILEPATH }} )" >> $GITHUB_OUTPUT
          # Next (currently not supported) PHP version to assess (e.g Current dev version)
          echo "php-next-version=$( jq -r '.php.next' ${{ env.VERSIONS_FILEPATH }} )" >> $GITHUB_OUTPUT
  tests:
    name: ${{ matrix.job-name }}
    needs: [fetch-supported-versions]
    runs-on: ubuntu-latest
    env:
      COVERAGE_TYPE: none
      COVERAGE_OUTPUT_STYLE: clover
    strategy:
      fail-fast: true
      matrix:
        include:
          - job-name: Up to date versions # => Highest versions allowed by composer config
            php-version: '${{ needs.fetch-supported-versions.outputs.php-max }}'
          - job-name: Bare minimum # => Lowest versions allowed by composer config
            php-version: '${{ needs.fetch-supported-versions.outputs.php-min }}'
    steps:
      - name: Check out code
        uses: actions/checkout@v5

      # Enable coverage only for specific version(s) !
      # Usually highest version(s), plus additional ones in case of code used only with specific versions
      - name: Enable coverage
        if: ${{ matrix.php-version == needs.fetch-supported-versions.outputs.php-max }}
        run: |
          echo "COVERAGE_TYPE=xdebug" >> $GITHUB_ENV

      - name: Setup PHP ${{ matrix.php-version }}
        id: setup-php
        uses: shivammathur/setup-php@v2
        env:
          update: true # whether to use latest available patch for the version or not
          fail-fast: true # step will fail if an extension or tool fails to set up
        with:
          php-version: ${{ matrix.php-version }}
          tools: composer
          coverage: ${{ env.COVERAGE_TYPE }}

      - name: Get composer cache directory
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

      - name: Setup cache for PHP ${{ steps.setup-php.outputs.php-version }}
        uses: actions/cache@v4
        with:
          path: |
            ${{ steps.composer-cache.outputs.dir }}
          # Clear the cache if composer.json (as composer.lock is not available) has been updated
          key: tests-php${{ steps.setup-php.outputs.php-version }}-${{ hashFiles('composer.json') }}

      - name: Build with PHP ${{ steps.setup-php.outputs.php-version }}
        run: make build

      - name: Tests
        run: make test-unit && make test-functional

      - name: Create "unit tests" reports group
        if: ${{ env.COVERAGE_TYPE == 'xdebug' }}
        uses: yoanm/temp-reports-group-workspace/create-group@v0
        with:
          name: unit-tests
          format: clover
          files: build/coverage-phpunit/unit.clover
          flags: |
            unit-tests
            php-${{ matrix.php-version }}
          path: build/coverage-groups

      - name: Create "functional tests" reports group
        if: ${{ env.COVERAGE_TYPE == 'xdebug' }}
        uses: yoanm/temp-reports-group-workspace/create-group@v0
        with:
          name: functional-tests
          format: clover
          files: |
            build/coverage-phpunit/functional.clover
            build/coverage-behat/clover.xml
          flags: |
            functional-tests
            php-${{ matrix.php-version }}
          path: build/coverage-groups

      - name: Upload coverage reports
        if: ${{ env.COVERAGE_TYPE == 'xdebug' }}
        uses: actions/upload-artifact@v4
        with:
          name: coverage-groups-php${{ steps.setup-php.outputs.php-version }}
          path: build/coverage-groups
          if-no-files-found: error

  static-checks:
    name: Static analysis
    needs: [fetch-supported-versions]
    runs-on: ubuntu-latest
    env:
      PHP_VERSION: ${{ needs.fetch-supported-versions.outputs.php-max }}
    steps:
      - uses: actions/checkout@v5

      - name: Setup PHP ${{ env.PHP_VERSION }}
        id: setup-php
        uses: shivammathur/setup-php@v2
        env:
          update: true # Always use latest available patch for the version
          fail-fast: true # step will fail if an extension or tool fails to set up
        with:
          php-version: ${{ env.PHP_VERSION }}
          tools: composer
          coverage: none

      - name: Get composer cache directory
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

      - name: Setup cache for PHP ${{ steps.setup-php.outputs.php-version }}
        uses: actions/cache@v4
        with:
          path: |
            ${{ steps.composer-cache.outputs.dir }}
          # Clear the cache if composer.json (as composer.lock is not available) has been updated
          key: tests-php${{ steps.setup-php.outputs.php-version }}-${{ hashFiles('composer.json') }}

      - name: Build with PHP ${{ steps.setup-php.outputs.php-version }}
        run: make build

      - name: ComposerRequireChecker
        uses: docker://webfactory/composer-require-checker:4.5.0

      - name: Dependencies check
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/dependency-review-action@v4

  nightly-tests:
    name: Nightly
    needs: [ fetch-supported-versions, tests ]
    runs-on: ubuntu-latest
    continue-on-error: true
    env:
      PHP_VERSION: ${{ needs.fetch-supported-versions.outputs.php-next }}
      COMPOSER_IGNORE_PLATFORM_REQ: 'php+'
    steps:
      - name: Check out code
        uses: actions/checkout@v5

      - name: Setup PHP ${{ env.PHP_VERSION }}
        id: setup-php
        uses: shivammathur/setup-php@v2
        env:
          update: true # whether to use latest available patch for the version or not
          fail-fast: true # step will fail if an extension or tool fails to set up
        with:
          php-version: ${{ env.PHP_VERSION }}
          tools: composer
          coverage: none

      - name: Get composer cache directory
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

      - name: Setup cache for PHP ${{ steps.setup-php.outputs.php-version }}
        uses: actions/cache@v4
        with:
          path: |
            ${{ steps.composer-cache.outputs.dir }}
          # Clear the cache if composer.json (as composer.lock is not available) has been updated
          key: tests-php${{ steps.setup-php.outputs.php-version }}-${{ hashFiles('composer.json') }}

      - name: Build with PHP ${{ steps.setup-php.outputs.php-version }}
        run: make build

      - name: Test
        run: make test-unit && make test-functional
