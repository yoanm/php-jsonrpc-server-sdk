name: 'Codacy upload'
on:
  workflow_call:
    inputs:
      artifacts-pattern:
        required: true
        type: string
    secrets:
      PROJECT_TOKEN:
        required: true
    outputs:
      files:
        description: TODO
        value: ${{ jobs.upload.outputs.json-files }}
      result:
        description: TODO
        value: ${{ jobs.upload.outputs.result }}

jobs:
  upload:
    name: Upload reports
    runs-on: ubuntu-latest
    outputs:
      files: ${{ steps.upload.outputs.files }}
      result: ${{ steps.upload.result }}
    steps:
      # @TODO move codacy-multi-group-upload action to a dedicated repo and remove the checkout
      - uses: actions/checkout@v3
        with:
          path: custom-action-repo

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: ${{ inputs.artifacts-pattern }}
          path: codacy-upload-from-artifacts-workflow-artefacts

      - name: DEBUG artifacts
        run: |
          ls -ail codacy-upload-from-artifacts-workflow-artefacts/*
          ls -ail codacy-upload-from-artifacts-workflow-artefacts/*/*

      - name: Upload reports
        id: upload
        uses: ./custom-action-repo/.github/actions/codacy-multi-group-upload
        with:
          project-token: ${{ secrets.PROJECT_TOKEN }}
          root: codacy-upload-from-artifacts-workflow-artefacts

      - name: DEBUG Upload reports
        run: |
          echo 'files=\'${{ steps.upload.outputs.files }}\''
          echo 'result=\'${{ steps.upload.outputs.result }}\''
